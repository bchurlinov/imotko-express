enum AgencyPlan {
  BASIC
  PREMIUM
}

enum AgencyApprovalStatus {
  DECLINED
  PENDING
  APPROVED
  DELETED
}

enum AgencyInvitationStatus {
  pending
  accepted
  declined
  expired
}

enum AgencyRole {
  OWNER
  ADMIN
  AGENT
  MEMBER
}

model Agency {
  id                     String                  @id @default(cuid())
  status                 AgencyApprovalStatus    @default(PENDING)
  imotkoApproved         Boolean                 @default(false)
  plan                   AgencyPlan              @default(BASIC)
  planUntil              DateTime?
  email                  String?
  taxNumber              String?
  name                   String
  description            Json?
  slug                   String?
  address                String
  phone                  String?
  location               String?
  social                 Json?
  logo                   Json?
  credits                Int                     @default(0)
  owner                  String
  users                  User[]
  ratings                AgencyReview[]
  properties             Property[]
  propertySale           PropertySale[]
  agencyView             AgencyView[]
  proposalOffer          ProposalOffer[]
  AgencySubmissionReview AgencySubmissionReview?
  //
  ownerId                String?                 @unique
  agencyOwner            User?                   @relation("AgencyOwner", fields: [ownerId], references: [id])
  agencyMembers          AgencyMember[]
  agencyInvitation       AgencyInvitation[]
  agencyClient           AgencyClient[]          @relation("AgencyClient")
  //
  createdAt              DateTime                @default(now()) @db.Timestamptz(3)
  updatedAt              DateTime                @updatedAt @db.Timestamptz(3)

  @@index([location])
  @@index([name])
}

model AgencyClientNotes {
  id              String       @id @default(cuid())
  title           String
  description     String
  agencyClientId  String
  agencyClient    AgencyClient @relation(fields: [agencyClientId], references: [id], onDelete: Cascade)
  createdById     String
  createdByMember AgencyMember @relation(fields: [createdById], references: [id])
  createdAt       DateTime     @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime     @updatedAt @db.Timestamptz(3)
}

enum AgencyClientStatus {
  active
  inactive
}

model AgencyClient {
  id               String                   @id @default(cuid())
  name             String
  lastName         String?
  email            String?
  phone            String?
  status           AgencyClientStatus?      @default(active)
  memberNotes      AgencyClientNotes[]
  location         String?
  agencyId         String
  agency           Agency                   @relation("AgencyClient", fields: [agencyId], references: [id], onDelete: Cascade)
  createdById      String?
  createdBy        AgencyMember?            @relation("ClientCreatedBy", fields: [createdById], references: [id])
  preferences      AgencyClientPreference[]
  ownedProperties  Property[]               @relation("PropertyOwner")
  rentedProperties Property[]               @relation("PropertyRenter")
  createdAt        DateTime                 @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime                 @updatedAt @db.Timestamptz(3)
}

enum AgencyClientPreferenceStatus {
  active
  sent
  interested
  not_interested
  inactive
  expired
}

model AgencyClientPreference {
  id                 String                       @id @default(cuid())
  propertyType       PropertyType?
  listingType        PropertyListingType?
  minPrice           Int?
  maxPrice           Int?
  minSize            Int?
  maxSize            Int?
  categoryId         String?
  subcategoryId      String?
  locationId         String?
  location           String?
  //
  createdById        String?
  createdBy          AgencyMember?                @relation("ClientPreferenceCreatedBy", fields: [createdById], references: [id])
  //
  agencyClientId     String?
  agencyClient       AgencyClient?                @relation(fields: [agencyClientId], references: [id], onDelete: Cascade)
  offeredPropertyIds String[]                     @default([])
  createdAt          DateTime                     @default(now()) @db.Timestamptz(3)
  updatedAt          DateTime                     @updatedAt @db.Timestamptz(3)
  //
  status             AgencyClientPreferenceStatus @default(active)
  lastOfferSentAt    DateTime?

  @@index([agencyClientId])
  @@index([minPrice, maxPrice, propertyType])
}

enum AgencyMemberStatus {
  active
  suspended
  inactive
  deleted
}

enum AgencyMemberRole {
  viewer
  collaborator
  agent
  manager
  admin
}

model AgencyMember {
  id                     String                   @id @default(cuid())
  userId                 String                   @unique
  user                   User                     @relation("AgencyMember", fields: [userId], references: [id], onDelete: Cascade)
  agencyId               String?
  agency                 Agency?                  @relation(fields: [agencyId], references: [id])
  status                 AgencyMemberStatus?      @default(active)
  role                   AgencyMemberRole         @default(viewer)
  createdProperties      Property[]
  agencyClientNotes      AgencyClientNotes[]
  agencyClient           AgencyClient[]           @relation("ClientCreatedBy")
  AgencyClientPreference AgencyClientPreference[] @relation("ClientPreferenceCreatedBy")
  reminders              AgentReminder[]
  createdAt              DateTime?                @default(now()) @db.Timestamptz(3)
  updatedAt              DateTime?                @updatedAt @db.Timestamptz(3)
}

model AgencyInvitation {
  id        String                 @id @default(cuid())
  token     String                 @unique
  agencyId  String
  agency    Agency                 @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  email     String
  senderId  String
  sender    User                   @relation("InvitingSender", fields: [senderId], references: [id], onDelete: Cascade)
  status    AgencyInvitationStatus @default(pending)
  expiresAt DateTime
  createdAt DateTime               @default(now()) @db.Timestamptz(3)
  updatedAt DateTime               @updatedAt @db.Timestamptz(3)
}

model AgencySubmissionReview {
  id          String   @id @default(cuid())
  agencyId    String   @unique
  agency      Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  title       Json
  description Json
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)
}

model AgencyView {
  id             String   @id @default(cuid())
  agencyId       String
  agency         Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  clientId       String?
  client         Client?  @relation(fields: [clientId], references: [id])
  additionalInfo Json?
  viewDate       DateTime @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime @updatedAt @db.Timestamptz(3)

  @@index([agencyId])
  @@index([clientId])
}

model AgencyReview {
  id         String   @id @default(cuid())
  approved   Boolean  @default(false)
  rating     Float
  comment    String?
  createdAt  DateTime @default(now()) @db.Timestamptz(3)
  attributes Json?
  agencyId   String
  agency     Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  clientId   String
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

enum ReminderStatus {
  ACTIVE
  PAUSED
  COMPLETED
  EXPIRED
}

model AgentReminder {
  id             String         @id @default(cuid())
  title          String
  description    String
  status         ReminderStatus @default(ACTIVE)
  agencyMemberId String
  agencyMember   AgencyMember   @relation(fields: [agencyMemberId], references: [id], onDelete: Cascade)
  // Scheduling fields (NEW)
  startDate      DateTime       @db.Timestamptz(3) // When to start sending
  isRecurring    Boolean        @default(false) // Daily or one-time
  endDate        DateTime?      @db.Timestamptz(3) // When to stop (optional)
  // Tracking field (NEW)
  lastSentAt     DateTime?      @db.Timestamptz(3) // Track last notification sent
  //
  createdAt      DateTime?      @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime?      @updatedAt @db.Timestamptz(3)

  @@index([agencyMemberId])
  @@index([status])
}

model Client {
  id                    String                       @id @default(cuid())
  clientSubscription    ClientPropertySubscription[]
  favorites             PropertyFavorite[]
  propertyViews         PropertyView[]
  clientSearches        ClientSearch[]
  reviews               AgencyReview[]
  receiveCompanyEmail   Boolean?                     @default(false)
  receiveCompanySMS     Boolean?                     @default(false)
  receiveAgentEmail     Boolean?                     @default(false)
  receiveAgentSMS       Boolean?                     @default(false)
  userId                String                       @unique
  user                  User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt @db.Timestamptz(3)
  AgencyView            AgencyView[]
  PropertyEngagement    PropertyEngagement[]
  Proposal              Proposal[]
  ProposalCollaboration ProposalCollaboration[]
  preferences           Json?

  @@index([userId])
}

model ClientSearch {
  id                         String                      @id @default(cuid())
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt @db.Timestamptz(3)
  clientId                   String
  client                     Client                      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  title                      Json
  link                       String
  filters                    Json
  clientPropertySubscription ClientPropertySubscription?
  receiveOffers              Boolean                     @default(false)
  agencyIdsJson              Json?
}

model ClientPropertySubscription {
  id             String               @id @default(cuid())
  minSize        Int?
  maxSize        Int?
  minPrice       Int?
  maxPrice       Int?
  location       String?
  listingType    PropertyListingType?
  category       String
  subCategory    String?
  createdAt      DateTime             @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime             @updatedAt @db.Timestamptz(3)
  clientId       String?
  client         Client?              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientSearchId String?              @unique()
  clientSearch   ClientSearch?        @relation(fields: [clientSearchId], references: [id], onDelete: Cascade)
}

model SearchQuery {
  id          String              @id @default(cuid())
  location    String
  listingType PropertyListingType
  category    String
  subCategory String?
  priceFrom   Int?
  priceTo     Int?
  sizeFrom    Int?
  sizeTo      Int?
  clientId    String?
  createdAt   DateTime            @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime            @updatedAt @db.Timestamptz(3)

  @@index([location, listingType, category])
}

enum ExternalListingCategory {
  FOR_SALE
  FOR_RENT
  TO_BUY
  TO_RENT
}

model ExternalListing {
  id          String                  @id @default(cuid())
  category    ExternalListingCategory
  fullName    String
  type        String
  title       String
  description String
  price       String
  attributes  String?
  location    String
  phoneNumber String?
  email       String?
  sourceId    String
  sourceName  String
  url         String
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt @db.Timestamptz(3)

  @@index([category])
  @@index([location])
  @@index([sourceName])
  @@index([createdAt])
  @@map("listings")
}

enum PropertyType {
  flat
  house
  land
  holiday_home
  garage
  commercial
}

enum PropertyListingType {
  for_rent
  for_sale
}

enum PropertyOrientation {
  north
  south
  east
  west
  northeast
  southeast
  northwest
  southwest
}

enum PropertyReviewStatus {
  PENDING
  DECLINED
  APPROVED
}

enum PropertyStatus {
  DRAFT
  PENDING
  DECLINED
  PUBLISHED
  UNPUBLISHED
  DELETED
}

enum EngagementType {
  SHARE
  SUBSCRIBE
  FAVORITE
}

model Property {
  id                            String                     @id @default(cuid())
  name                          Json
  latitude                      Float
  address                       String
  longitude                     Float
  agencyId                      String?
  status                        PropertyStatus             @default(PENDING)
  price                         Int
  hasApproximatePrice           Boolean?                   @default(false)
  approximatePrice              Int?
  estimationPrice               Int?
  size                          Int
  description                   Json
  slug                          String?
  photos                        Json?
  video                         String?
  createdAt                     DateTime                   @default(now()) @db.Timestamptz(3)
  createdBy                     String
  createdByMemberId             String?
  createdByMember               AgencyMember?              @relation(fields: [createdByMemberId], references: [id])
  updatedAt                     DateTime                   @default(now()) @db.Timestamptz(3)
  attributes                    Json?
  yearBuilt                     DateTime?
  remarks                       String?
  builder                       String?
  propertyCadastralMunicipality String?
  propertyDeed                  String?
  inDevelopment                 Boolean?                   @default(false)
  inDevelopmentUntil            DateTime?                  @db.Timestamptz(3)
  propertyPlan                  Json?
  poi                           Json?
  featured                      Boolean                    @default(false)
  featuredUntil                 DateTime?
  orientation                   PropertyOrientation?
  views                         PropertyView[]
  type                          PropertyType
  listingType                   PropertyListingType
  agency                        Agency?                    @relation(fields: [agencyId], references: [id])
  PropertyFavorite              PropertyFavorite[]
  PropertySale                  PropertySale?
  PropertyEngagement            PropertyEngagement[]
  propertyReview                PropertySubmissionReview[]
  propertyLocation              PropertyLocation?          @relation(fields: [propertyLocationId], references: [id])
  propertyLocationId            String?
  modifications                 Json?
  categoryId                    String?
  category                      PropertyCategory?          @relation(fields: [categoryId], references: [id])
  subcategoryId                 String?
  subcategory                   PropertySubcategory?       @relation(fields: [subcategoryId], references: [id])
  ownerId                       String?
  owner                         AgencyClient?              @relation("PropertyOwner", fields: [ownerId], references: [id])
  renterId                      String?
  renter                        AgencyClient?              @relation("PropertyRenter", fields: [renterId], references: [id])
  externalId                    String?
  //
  autoRenewEnabled              Boolean                    @default(false)
  autoRenewStartDate            DateTime?
  autoRenewEndDate              DateTime?
  lastAutoRenewedAt             DateTime?
  bumpedAt                      DateTime?                  @db.Timestamptz(3)

  @@index([propertyLocationId, listingType])
  @@index([propertyLocationId])
  @@index([agencyId])
  @@index([bumpedAt])
}

model PropertyCategory {
  id            String                @id
  value         String
  properties    Property[]
  subcategories PropertySubcategory[]
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
}

model PropertySubcategory {
  id         String           @id
  value      String
  categoryId String
  category   PropertyCategory @relation(fields: [categoryId], references: [id])
  properties Property[]
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@unique([value, categoryId])
}

model PropertyLocation {
  id         String             @id @default(cuid())
  name       String             @unique
  parentId   String?
  parent     PropertyLocation?  @relation("ParentChild", fields: [parentId], references: [id])
  children   PropertyLocation[] @relation("ParentChild")
  properties Property[]
}

model PropertySubmissionReview {
  id          String   @id @default(cuid())
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  title       Json
  description Json
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)
}

model PropertySale {
  id           String   @id @default(cuid())
  propertyId   String   @unique
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  agencyId     String
  propertyDeed String
  agency       Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  soldAt       DateTime @default(now()) @db.Timestamptz(3)
  soldFor      Int
  visibility   Boolean  @default(true)
}

model PropertyView {
  id             String   @id @default(cuid())
  viewDate       DateTime @default(now()) @db.Timestamptz(3)
  propertyId     String
  clientId       String?
  property       Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  client         Client?  @relation(fields: [clientId], references: [id])
  additionalInfo Json?
  createdAt      DateTime @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime @updatedAt @db.Timestamptz(3)

  @@index([propertyId])
  @@index([clientId])
}

model PropertyFavorite {
  id           String    @id @default(cuid())
  favoriteDate DateTime  @db.Timestamptz(3)
  propertyId   String?
  property     Property? @relation(fields: [propertyId], references: [id])
  clientId     String?
  client       Client?   @relation(fields: [clientId], references: [id])

  @@index([propertyId])
  @@index([clientId])
}

model PropertyEngagement {
  id             String         @id @default(cuid())
  propertyId     String
  property       Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  type           EngagementType
  clientId       String?
  client         Client?        @relation(fields: [clientId], references: [id])
  createdAt      DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt      DateTime       @updatedAt @db.Timestamptz(3)
  additionalInfo Json?
}

enum ProposalStatus {
  published
  unpublished
  deleted
}

model Proposal {
  id          String              @id @default(cuid())
  title       String
  description String
  location    String
  size        Int?
  category    PropertyType
  listingType PropertyListingType
  status      ProposalStatus      @default(published)
  photos      Json?
  clientId    String
  client      Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  offers      ProposalOffer[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt @db.Timestamptz(3)
}

model ProposalOffer {
  id                    String                 @id @default(cuid())
  title                 String
  price                 Int
  description           String
  saleTimeline          DateTime
  proposalId            String
  proposal              Proposal               @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  agencyId              String
  agency                Agency                 @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  proposalCollaboration ProposalCollaboration?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt @db.Timestamptz(3)

  @@index([proposalId])
}

model ProposalCollaboration {
  id              String         @id @default(cuid())
  clientId        String
  client          Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  title           String
  description     String
  email           String
  phone           String?
  agencyId        String
  proposalOfferId String         @unique
  proposalOffer   ProposalOffer? @relation(fields: [proposalOfferId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt @db.Timestamptz(3)

  @@index([proposalOfferId])
}

enum UserRole {
  CLIENT
  AGENCY
  ADMIN
}

enum UserLanguage {
  EN
  MK
  AL
  SQ
}

enum NotificationStatus {
  READ
  UNREAD
}

model Admin {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                     String               @id @default(cuid())
  name                   String
  lastName               String?
  email                  String               @unique
  location               String?
  emailVerified          DateTime?
  image                  String?
  hashedPassword         String?
  phone                  String?
  accessToken            String?
  refreshToken           String?
  language               UserLanguage?        @default(MK)
  role                   UserRole             @default(CLIENT)
  account                Account?
  clientId               String?
  client                 Client?
  notifications          Notification[]
  agencyId               String?
  agency                 Agency?              @relation(fields: [agencyId], references: [id])
  adminId                String?
  admin                  Admin?
  ipAddress              String?
  UserFeatureRequest     UserFeatureRequest[]
  //
  agencyMember           AgencyMember?        @relation("AgencyMember")
  ownedAgency            Agency?              @relation("AgencyOwner")
  //
  agencyInvitationSender AgencyInvitation[]   @relation("InvitingSender")
  createdAt              DateTime?            @default(now()) @db.Timestamptz(3)
  updatedAt              DateTime?            @updatedAt @db.Timestamptz(3)

  @@index([agencyId])
  @@index([clientId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @unique
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Notification {
  id          String             @id @default(cuid())
  title       String
  description String
  status      NotificationStatus @default(UNREAD)
  recipientId String
  recipient   User               @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  createdAt   DateTime           @default(now())
  readAt      DateTime?
  metadata    Json?
}

model UserFeatureRequest {
  id          String    @id @default(cuid())
  featureName String
  userId      String?
  user        User?     @relation(fields: [userId], references: [id])
  createdAt   DateTime? @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime? @updatedAt @db.Timestamptz(3)

  @@index([userId])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String   @unique
  userId  String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

//! Run Migration -> npx prisma migrate dev
//! Generate Migraitons -> npx prisma generate
//! RESET DB -> npx prisma db push --force-reset
//! Prisma Studio -> npx prisma studio 
//! Create migration but don't apply it -> npx migrate dev --create-only
//! Create migration after saving it -> npx prisma migrate up
// npx prisma migrate status
// Create migration without applying it -> npx prisma migrate dev --create-only --name update_user_language
// Delete failed migration in Supabase SQL client => DELETE FROM _prisma_migrations WHERE migration_name = '20240825095759_user_language_change';
// npx prisma migrate resolve --applied "20250109191434_proposal_offer_title"

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["fullTextSearchPostgres", "relationJoins"]
  moduleFormat    = "esm"
  binaryTargets   = ["native", "linux-arm64-openssl-3.0.x", "rhel-openssl-3.0.x"]
  engineType      = "library"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
